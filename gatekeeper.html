<!DOCTYPE html>
<html>
<head>

<style>
body {
    // NOTE: We may need to update this dynamically
    //       to support imported body styles.
    margin: 0;
    padding: 0;
}
</style>

<script src="https://cdn.0net.io/libs/jquery/3.3.1/js/jquery.min.js"></script>
<script>
/* Initialize parent manager. */
let parent = null

/* Initialize origin manager. */
let origin = null

/**
 * @notice Initialize the gateway.
 *
 * @dev We want to set the security to our parent to prevent any
 *      unauthorized communication with any "malicious" 3rd-parties
 *      who may be eavesdropping.
 */
const _init = function (_event) {
    /* Validate the origin of our parent is ONLY one from an approved list. */
    if (_event.origin === 'https://0net.io' || _event.origin === 'https://web.0net.io') {
        /* Set security flag. */
        // isSecure = true

        /* Set the parent manager. */
        parent = _event.source

        /* Set the origin manager. */
        origin = _event.origin

        return true
    } else {
        return false
    }
}

const _callback = function (_message) {
    /* Validate the response. */
    if (parent && origin && _message) {
        parent.postMessage(_message, origin)
    } else {
        throw new Error('Oh no! Something smells wrong about this action.')
    }
}

window.addEventListener('message', function (_event) {
    // console.log('Gatekeeper received event', _event)

    /* Initailize body. */
    let body = null

    /* Initailize data. */
    let data = null

    /* Initailize error. */
    let error = null

    /* Initialize message. */
    let message = null

    /* Initialize msg. */
    let msg = null

    /* Initialize pkg. */
    let pkg = null

    /* Initialize success. */
    let success = null

    /* Verify parent is authorized and set. */
    if (!parent) {
        /* Attempt to initialize the gateway. */
        if (_init(_event)) {
            /* Set success flag. */
            success = true

            /* Set message. */
            msg = 'GATEKEEPER_IS_READY'

            /* Build message. */
            message = { success, msg }

            /* Callback to parent. */
            return _callback(message)
        } else {
            /* Set error flag. */
            error = true

            /* Set message. */
            msg = 'Authorization failed!'

            /* Build message. */
            message = { error, msg }

            /* Callback to parent. */
            return _callback(message)
        }
    }

    /* All messages should be JSON strings, so let's try to decode to an object. */
    try {
        /* Retrieve the data. */
        data = _event.data

        /* Validate data. */
        if (!data) {
            return
        }

        /* Retrieve html body. */
        body = data.body

        if (data.prepend) {
            /* Prepend the data to the frame's html body. */
            $('body').prepend(body)
        } else if (data.append) {
            /* Append the data to the frame's html body. */
            $('body').append(body)
        } else {
            /* Replace the data on the frame's html body. */
            $('body').html(body)
        }

        /* Scroll to the top. */
        $('html, body').scrollTop(0)
    } catch (_err) {
        /* Set error flag. */
        error = true

        /* Set message. */
        msg = _err.message

        /* Build error. */
        pkg = { error, msg }

        /* Callback to parent. */
        return _callback(pkg)
    }
})
</script>
</head>
<body></body>
</html>
